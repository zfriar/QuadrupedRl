name: CI

on:
  push:
    branches: [ main, feature/** ]
  pull_request:
    branches: [ main ]

defaults:
  run:
    shell: bash -l {0}

jobs:
  precommit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Poetry
        run: python -m pip install --upgrade pip poetry

      - name: Configure Poetry venv
        run: poetry config virtualenvs.in-project true

      - name: Install dependencies (dev)
        run: poetry install --no-interaction --no-ansi

      - name: Run pre-commit hooks (verify)
        run: poetry run pre-commit run --all-files

  code-checks:
    needs: precommit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Poetry
        run: python -m pip install --upgrade pip poetry

      - name: Configure Poetry venv
        run: poetry config virtualenvs.in-project true

      - name: Install dependencies (dev)
        run: poetry install --no-interaction --no-ansi

      - name: Run formatting, lint, and typecheck
        run: make code-checks

  coverage:
    needs: code-checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Poetry
        run: python -m pip install --upgrade pip poetry

      - name: Configure Poetry venv
        run: poetry config virtualenvs.in-project true

      - name: Install dependencies (dev)
        run: poetry install --no-interaction --no-ansi

      - name: Run tests and generate coverage
        run: make coverage

